/*
Deployment script for Unified Claims Analytics

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "Unified Claims Analytics"
:setvar DefaultFilePrefix "Unified Claims Analytics"
:setvar DefaultDataPath "C:\Users\tmcgowen\AppData\Local\Microsoft\VisualStudio\SSDT\Unified Claims Analytics"
:setvar DefaultLogPath "C:\Users\tmcgowen\AppData\Local\Microsoft\VisualStudio\SSDT\Unified Claims Analytics"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Creating [dbo].[Member_CondHier_PPPM_vw]...';


GO
CREATE VIEW [dbo].[Member_CondHier_PPPM_vw]
	AS 

select * 
    , case when Condition in ('Affective Psychosis','Anxiety','Depression','Eating Disorders','PTSD','Substance Abuse') then 1
		when Condition = 'Congestive Heart Failure' then 2
		when Condition = 'CAD' then 3
		when Condition = 'COPD' then 4
		when Condition = 'Diabetes' then 5
		when Condition = 'Hypertension' then 6
		when Condition = 'Obesity' then 7
		when Condition = 'Back and Neck Pain' then 8
		when Condition = 'Asthma' then 9
		else 99 end as Hierarchy 
    , case  when Condition in ('Affective Psychosis','Anxiety','Depression','Eating Disorders','PTSD','Substance Abuse')  then 'MH-6'  
		when Condition = 'Congestive Heart Failure' then 'Congestive Heart Failure'  
		when Condition = 'CAD' then 'CAD'
		when Condition = 'COPD' then 'COPD'
		when Condition = 'Diabetes' then 'Diabetes'
		when Condition = 'Hypertension' then 'Hypertension'
		when Condition = 'Obesity' then 'Obesity'
		when Condition = 'Back and Neck Pain' then 'Back and Neck Pain'
		when Condition = 'Asthma' then 'Asthma'
		  end as CondHier
    , dense_rank() over (partition by MemberID, Yr order by case when Condition in ('Affective Psychosis','Anxiety','Depression','Eating Disorders','PTSD','Substance Abuse') then 1
											   when Condition = 'Congestive Heart Failure' then 2
											   when Condition = 'CAD' then 3
											   when Condition = 'COPD' then 4
											   when Condition = 'Diabetes' then 5
											   when Condition = 'Hypertension' then 6
											   when Condition = 'Obesity' then 7
											   when Condition = 'Back and Neck Pain' then 8
											   when Condition = 'Asthma' then 9
											   end ASC )  as CondRnk

from [dbo].[Member_Conditions_PPPM_vw]
where CondGrpType = 'Standard Condition'
    and Condition in ('Affective Psychosis','Anxiety','Depression','Eating Disorders','PTSD','Substance Abuse', 'Congestive Heart Failure'
	   , 'CAD', 'COPD', 'Diabetes', 'Hypertension', 'Obesity' , 'Back and Neck Pain', 'Asthma' )
GO
PRINT N'Creating [dbo].[Member_PrimaryConditions_PPPM_vw]...';


GO
CREATE VIEW [dbo].[Member_PrimaryConditions_PPPM_vw]
	AS 
select ClientID
	,PrimemberID
    , MemberID
    , CondGrpType
    , coalesce([ConditionID], '0') as [ConditionID]
    , coalesce([Condition], 'Other Cond/Ill/Inj') as [Condition]
    , Min(FromServiceDate) as FrstOcc
    , Max(FromServiceDate)  as LstOcc
    , sum([PaidAmt]) as PaidAmt
	, sum(case when [ClassifierUSPM] = 'IP' then PaidAmt else 0 END) as 'IPPaid'
    , sum(case when [ClassifierUSPM] = 'ER' then PaidAmt else 0 end) as 'ERPaid'
    , sum(case when [ClassifierUSPM] = 'OP' then PaidAmt else 0 END) as 'OPPaid'
    , sum(case when [ClassifierUSPM] = 'OV' then PaidAmt else 0 end) as 'OVPaid'
    , sum(case when [ClassifierUSPM] = 'OTH' then PaidAmt else 0 end) as 'OTHPaid'
	

    , sum(case when ((left(icd1,1) in ( '8','9')  and convert(date,FromServiceDate) < '10/1/2015')
	   or (left(icd1,1) in ('S','T')  and convert(date,FromServiceDate) >= '10/1/2015')
	   or (left(icd2,1) in ('8','9')  and convert(date,FromServiceDate) < '10/1/2015')
	   or (left(icd2,1) in ('S','T')  and convert(date,FromServiceDate) >= '10/1/2015'))
		then PaidAmt else 0 end)
		as TramaPaid

    , sum(case when ((left(icd1,1) in ( '8','9')  and convert(date,FromServiceDate) < '10/1/2015')
	   or (left(icd1,1) in ('S','T')  and convert(date,FromServiceDate) >= '10/1/2015')
	   or (left(icd2,1) in ('8','9')  and convert(date,FromServiceDate) < '10/1/2015')
	   or (left(icd2,1) in ('S','T')  and convert(date,FromServiceDate) >= '10/1/2015')
		  and   ([ClassifierUSPM] = 'IP') )
		  Then PaidAmt else 0 end) as TramaIPPaid

	, sum(case when (((left(icd1,1) in ( '8','9')  and convert(date,FromServiceDate) < '10/1/2015')
	or (left(icd1,1) in ('S','T')  and convert(date,FromServiceDate) >= '10/1/2015')
	or (left(icd2,1) in ('8','9')  and convert(date,FromServiceDate) < '10/1/2015')
	or (left(icd2,1) in ('S','T')  and convert(date,FromServiceDate) >= '10/1/2015'))
		  and   ([ClassifierUSPM] = 'ER'))
			 Then PaidAmt else 0 end) as TramaERPaid
    , 1 as IsPrim
    , max([YrMth]) as YrMth
from [dbo].[MedicalClaims_Base] m
    left join [dbo].[ref_ICDtoCond] ic
	   on m.ICD1 = ic.ICDCode

group by 
     PrimemberID
    , ClientID
    , MemberID
    , CondGrpType
    , coalesce([ConditionID], '0') 
    , coalesce([Condition], 'Other Cond/Ill/Inj') 
    , [YrMth]
GO
PRINT N'Creating [dbo].[fnCheckCustomFlag]...';


GO
CREATE FUNCTION [dbo].[fnCheckCustomFlag]
(
	@value1 varchar(25)
)
Returns varchar(25)
as
BEGIN
Return 
case when (select [Custom2_disabled] from [dbo].Reporting_Parms where sts = 'a') = 1 then 'x' else @value1  end
END
GO
PRINT N'Creating [dbo].[HealthCareSpend_Excl_Summary]...';


GO
CREATE VIEW [dbo].[HealthCareSpend_Excl_Summary]
as
	select [Year]
	, [Relationship] 
	, [dbo].[fnCheckCustomFlag](Custom1) as Custom1
	, [dbo].[fnCheckCustomFlag](Custom2) as Custom2

    , count(distinct concat(PriMemberID, MemberID)) as TotPop
    , sum(FTE)/12 as AvgPop
    , sum(case when FTE = 12 then 1 else 0 end) as StablePop
    , sum(case when FTE <> 12 then 1 else 0 end) as ChngPop
    , sum(case when FTE <> 12 then FTE else 0 end)/12 as ChngPopFTE
    , sum(FTE)/count(distinct concat(PriMemberID, MemberID)) as AvgMthsPPPY
    , (Sum(MedwStopLossExcl) + Sum(PharmwStopLossExcl))/(sum(FTE)/12) as PPPY
    , (Sum(MedwStopLossExcl) + Sum(PharmwStopLossExcl))/(sum(FTE)) as PPPM
    , Sum(MedwStopLossExcl) + Sum(PharmwStopLossExcl) as TotPaid
    , Sum(MedwStopLossExcl) as TotMed
    , Sum(PharmwStopLossExcl) as TotPharm
    , Sum(MedwStopLossExcl)/(sum(FTE)/12) as AvgMedPPPY
    , Sum(MedwStopLossExcl)/(sum(FTE)) as AvgMedPPPM
    , Sum(MedClaims) as TotMedClaims
    , Sum(MedwStopLossExcl)/Sum(MedClaims) as AvgMedPClaim
    , count(distinct case when isnull(medclaims, 0) > 0 then Concat(PriMemberID, MemberID)  end) as TotMedClaimants
    , sum(case when isnull(medclaims, 0) > 0 then FTE else 0 end)/12 as AvgMedClaimants
    , Sum(MedwStopLossExcl)/(sum(case when isnull(medclaims, 0) > 0 then FTE else 1 end)/12) as AvgMedPCPY
    , Sum(MedwStopLossExcl)/(sum(case when isnull(medclaims, 0) > 0 then FTE else 1 end)) as AvgMedPCPM
   
    , Sum(PharmwStopLossExcl)/(sum(FTE)/12) as AvgPharmPPPY
    , Sum(PharmwStopLossExcl)/(sum(FTE)) as AvgPharmPPPM
    , Sum(PharmClaims) as TotPharmClaims
    , Sum(PharmwStopLossExcl)/Sum(PharmClaims) as AvgPharmPClaim
    , count(case when isnull(Pharmclaims, 0) > 0 then  Concat(PriMemberID, MemberID)  end) as TotPharmClaimants
    , sum(case when isnull(Pharmclaims, 0) > 0 then FTE else 1 end)/12 as AvgPharmClaimants
    , Sum(PharmwStopLossExcl)/(sum(case when isnull(Pharmclaims, 0) > 0 then FTE else 1 end)/12) as AvgPharmPCPY
    , Sum(PharmwStopLossExcl)/(sum(case when isnull(Pharmclaims, 0) > 0 then FTE else 1 end)) as AvgPharmPCPM
    , (case when Relationship = 'E' then 1 when Relationship = 'S' then 2 when Relationship = 'D' then 3 else 4 end) as  ord
  
from  [dbo].[PPPY_Summary] with (nolock)
group by [Year]
    , [Relationship] 
    , [dbo].[fnCheckCustomFlag](Custom1)
	, [dbo].[fnCheckCustomFlag](Custom2)
GO
PRINT N'Creating [dbo].[HealthCareSpend_Summary]...';


GO
CREATE VIEW [dbo].[HealthCareSpend_Summary]
as
	select [Year]
	, [Relationship] 
	, [dbo].[fnCheckCustomFlag](Custom1) as Custom1
	, [dbo].[fnCheckCustomFlag](Custom2) as Custom2
    , count(distinct concat(PriMemberID, MemberID)) as TotPop
    , sum(FTE)/12 as AvgPop
    , sum(case when FTE = 12 then 1 else 0 end) as StablePop
    , sum(case when FTE <> 12 then 1 else 0 end) as ChngPop
    , sum(case when FTE <> 12 then FTE else 0 end)/12 as ChngPopFTE
    , sum(FTE)/count(distinct concat(PriMemberID, MemberID)) as AvgMthsPPPY
    , (Sum(MedPaid) + Sum(PharmPaid))/(sum(FTE)/12) as PPPY
    , (Sum(MedPaid) + Sum(PharmPaid))/(sum(FTE)) as PPPM
    , Sum(MedPaid) + Sum(PharmPaid) as TotPaid
    , Sum(MedPaid) as TotMed
    , Sum(PharmPaid) as TotPharm
    , Sum(MedPaid)/(sum(FTE)/12) as AvgMedPPPY
    , Sum(MedPaid)/(sum(FTE)) as AvgMedPPPM
    , Sum(MedClaims) as TotMedClaims
    , Sum(MedPaid)/Sum(MedClaims) as AvgMedPClaim
    , count(distinct case when isnull(medclaims, 0) > 0 then Concat(PriMemberID, MemberID)  end) as TotMedClaimants
    , sum(case when isnull(medclaims, 0) > 0 then FTE else 0 end)/12 as AvgMedClaimants
    , Sum(MedPaid)/(sum(case when isnull(medclaims, 0) > 0 then FTE else 1 end)/12) as AvgMedPCPY
    , Sum(MedPaid)/(sum(case when isnull(medclaims, 0) > 0 then FTE else 1 end)) as AvgMedPCPM
   
    , Sum(PharmPaid)/(sum(FTE)/12) as AvgPharmPPPY
    , Sum(PharmPaid)/(sum(FTE)) as AvgPharmPPPM
    , Sum(PharmClaims) as TotPharmClaims
    , Sum(PharmPaid)/Sum(PharmClaims) as AvgPharmPClaim
    , count(case when isnull(Pharmclaims, 0) > 0 then  Concat(PriMemberID, MemberID)  end) as TotPharmClaimants
    , sum(case when isnull(Pharmclaims, 0) > 0 then FTE else 1 end)/12 as AvgPharmClaimants
    , Sum(PharmPaid)/(sum(case when isnull(Pharmclaims, 0) > 0 then FTE else 1 end)/12) as AvgPharmPCPY
    , Sum(PharmPaid)/(sum(case when isnull(Pharmclaims, 0) > 0 then FTE else 1 end)) as AvgPharmPCPM
    , (case when Relationship = 'E' then 1 when Relationship = 'S' then 2 when Relationship = 'D' then 3 else 4 end) as  ord
  
from  [dbo].[PPPY_Summary] with (nolock)
group by [Year]
    , [Relationship] 
    , [dbo].[fnCheckCustomFlag](Custom1) 
	, [dbo].[fnCheckCustomFlag](Custom2)
GO
PRINT N'Update complete.';


GO
