/*
Deployment script for OppAnalysisEngine

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "OppAnalysisEngine"
:setvar DefaultFilePrefix "OppAnalysisEngine"
:setvar DefaultDataPath "C:\Program Files\Microsoft SQL Server\MSSQL12.MSSQLSERVER\MSSQL\DATA\"
:setvar DefaultLogPath "C:\Program Files\Microsoft SQL Server\MSSQL12.MSSQLSERVER\MSSQL\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Creating [dbo].[Number]...';


GO
CREATE TABLE [dbo].[Number] (
    [N] INT NOT NULL,
    CONSTRAINT [Number_PK] PRIMARY KEY CLUSTERED ([N] ASC) ON [PRIMARY]
) ON [PRIMARY];


GO
PRINT N'Creating [dbo].[Member_Exclusion_vw]...';


GO



CREATE view [dbo].[Member_Exclusion_vw]
as
with a
as
(
select --PriMemberID + '_' +  MemberRelCode + '_' + convert(varchar(4),year(convert(date,FromServiceDate)))+ '_' + convert(varchar(2),month(convert(date,FromServiceDate))) as MemberID_YMK
      MemberID
	, primemberID
    , case when Procedure1 in ('38240','38241','38242', '38243') then 'Transplant-Bone Marrow'
	   when Procedure1 in ('33945','33933','33944')  then 'Transplant-Heart'
	   when Procedure1 in ('33935')  then 'Transplant-HeartLung'
	   when Procedure1 in  ('44135','44136','44132','44133','44137') or Procedure1 between '44715' and '44721' then 'Transplant-Intestines'
	   when Procedure1 in ('47135','47136') or Procedure1 between '47143' and '47147'  then 'Transplant-Liver' 
	   when Procedure1 in ('32855','32856','33933','32850','32854','32853','32852','32851') then 'Transplant-Lung' 
	   when Procedure1 in ('48160','48550','48554','48555','48556','48551','48552')  then 'Transplant-Pancreas' 
	   when Procedure1 in ('60512')  then 'Transplant-Parathyroid' 
	   when Procedure1 in ('50360','50365','50380','50547','50340','50370')
		  or Procedure1 between '50323' and '50329' or Procedure1 between '50300' and '50320'  then 'Transplant-Renal' 
	   when left(billingCode, 1) = '2' then 'SNF'  --POS = '31' or 
	   when PlaceOfService = '34' then 'Hospice'
	--   when left(ICD1,3) = 'V23' or  ICD1 like 'O09%' then 'High Risk OB' 
	   when ICD1 in ('5856', 'N186') or ICD2 in ('5856', 'N186') then 'ESRD'
	   when left(ICD1,3) in ('042', 'B20') or left(ICD2,3) in ('042', 'B20') then 'HIV/AIDS'
	   when left(ICD1,3) ='286' or ICD1 = 'Z140' or ICD1 = 'D683' or left(ICD1,3) ='D66' then 'Hemophilia' 
	  
	   end  as Excl
	   , min(FromServiceDate) as Onset
	   , max(ToServiceDate) as MstRcnt
	   , sum(convert(money,PaidAmt)) as PaidAmt 
from [dbo].[MedicalClaims_Base]
group 
 by [MemberID]
  , primemberID
    , case when Procedure1 in ('38240','38241','38242', '38243') then 'Transplant-Bone Marrow'
	   when Procedure1 in ('33945','33933','33944')  then 'Transplant-Heart'
	   when Procedure1 in ('33935')  then 'Transplant-HeartLung'
	   when Procedure1 in  ('44135','44136','44132','44133','44137') or Procedure1 between '44715' and '44721' then 'Transplant-Intestines'
	   when Procedure1 in ('47135','47136') or Procedure1 between '47143' and '47147'  then 'Transplant-Liver' 
	   when Procedure1 in ('32855','32856','33933','32850','32854','32853','32852','32851') then 'Transplant-Lung' 
	   when Procedure1 in ('48160','48550','48554','48555','48556','48551','48552')  then 'Transplant-Pancreas' 
	   when Procedure1 in ('60512')  then 'Transplant-Parathyroid' 
	   when Procedure1 in ('50360','50365','50380','50547','50340','50370')
		  or Procedure1 between '50323' and '50329' or Procedure1 between '50300' and '50320'  then 'Transplant-Renal' 
	   when left(billingCode, 1) = '2' then 'SNF'  --POS = '31' or 
	   when PlaceOfService = '34' then 'Hospice'
	--   when left(ICD1,3) = 'V23' or  ICD1 like 'O09%' then 'High Risk OB' 
	   when ICD1 in ('5856', 'N186') or ICD2 in ('5856', 'N186') then 'ESRD'
	   when left(ICD1,3) in ('042', 'B20') or left(ICD2,3) in ('042', 'B20') then 'HIV/AIDS'
	   when left(ICD1,3) ='286' or ICD1 = 'Z140' or ICD1 = 'D683' or left(ICD1,3) ='D66' then 'Hemophilia' 
	   
	   end 
having sum(convert(money,PaidAmt)) > 500
)
select *
from a
where Excl is not null
union all
select MemberID
 , primemberID
    , 'Cancer'
    , FrstOcc
    , LstOcc
    , sum([PaidAmt]) as [PaidAmt]
from [dbo].[Member_Conditions_vw]
where Condition = 'Cancer'
group by MemberID
 , primemberID
    , FrstOcc
    , LstOcc
having sum(convert(money,PaidAmt)) > 500
GO
PRINT N'Creating [dbo].[Member_Exclusion_PPPM_vw]...';


GO



CREATE view [dbo].[Member_Exclusion_PPPM_vw]
as
select distinct MemberID
 , primemberID
    , Excl
    , Onset
    , MstRcnt
    , YrMth
    , MonthYear
    --, Month as Mth
    --, Year as Yr
    , 0 as AmtPaidMth
    , [PaidAmt] as TotAmtPaid
from [dbo].[Member_Exclusion_vw] e
    inner join  [dbo].[DateTable_Month] md
	   on md.Date between e.Onset and e.MstRcnt
GO
PRINT N'Creating [dbo].[Member_ClaimDays_vw]...';


GO

create view [dbo].[Member_ClaimDays_vw]
as
with e
as
(
select distinct  MemberID m,  YrMth k
froM [dbo].[Member_Exclusion_PPPM_vw]


) 


, a
as
(
select  [ClientId] 
, PriMemberID
    , [MemberID]
    , FromServiceDate as ServiceDate
    , [YrMth]
    --, PlanGroupID
    --, [ClaimNumber]
     , max(case when ((left(icd1,1) in ( '8','9')  and convert(date,FromServiceDate) < '10/1/2015') 
	   or (left(icd1,1) in ('S','T')  and convert(date,FromServiceDate) >= '10/1/2015')
	   or (left(icd2,1) in ( '8','9')  and convert(date,FromServiceDate) < '10/1/2015') 
	   or (left(icd2,1) in ('S','T')  and convert(date,FromServiceDate) >= '10/1/2015')
	   or (left(icd3,1) in ( '8','9')  and convert(date,FromServiceDate) < '10/1/2015') 
	   or (left(icd3,1) in ('S','T')  and convert(date,FromServiceDate) >= '10/1/2015')) Then 1 else 0 end) 
		  as TramaFlag

     , sum(case when ((left(icd1,1) in ( '8','9')  and convert(date,FromServiceDate) < '10/1/2015') 
	   or (left(icd1,1) in ('S','T')  and convert(date,FromServiceDate) >= '10/1/2015')
	   or (left(icd2,1) in ( '8','9')  and convert(date,FromServiceDate) < '10/1/2015') 
	   or (left(icd2,1) in ('S','T')  and convert(date,FromServiceDate) >= '10/1/2015')
	   or (left(icd3,1) in ( '8','9')  and convert(date,FromServiceDate) < '10/1/2015') 
	   or (left(icd3,1) in ('S','T')  and convert(date,FromServiceDate) >= '10/1/2015')) Then PaidAmt else 0 end) 
		  as TramaPaid

      , sum(case when ((left(icd1,1) in ( '8','9')  and convert(date,FromServiceDate) < '10/1/2015') 
	   or (left(icd1,1) in ('S','T')  and convert(date,FromServiceDate) >= '10/1/2015')
	   or (left(icd2,1) in ( '8','9')  and convert(date,FromServiceDate) < '10/1/2015') 
	   or (left(icd2,1) in ('S','T')  and convert(date,FromServiceDate) >= '10/1/2015')
	   or (left(icd3,1) in ( '8','9')  and convert(date,FromServiceDate) < '10/1/2015') 
	   or (left(icd3,1) in ('S','T')  and convert(date,FromServiceDate) >= '10/1/2015'))
		  and   ([ClassifierUSPM] = 'IP') 
		  Then PaidAmt else 0 end)
		  as TramaIPPaid

	  , sum(case when ((left(icd1,1) in ( '8','9')  and convert(date,FromServiceDate) < '10/1/2015') 
	   or (left(icd1,1) in ('S','T')  and convert(date,FromServiceDate) >= '10/1/2015')
	   or (left(icd2,1) in ( '8','9')  and convert(date,FromServiceDate) < '10/1/2015') 
	   or (left(icd2,1) in ('S','T')  and convert(date,FromServiceDate) >= '10/1/2015')
	   or (left(icd3,1) in ( '8','9')  and convert(date,FromServiceDate) < '10/1/2015') 
	   or (left(icd3,1) in ('S','T')  and convert(date,FromServiceDate) >= '10/1/2015')) 
		  and   ([ClassifierUSPM] = 'ER')
			 Then PaidAmt else 0 end) 
		  as TramaERPaid

    , max(isnull(serviceDays,0)) as IPAdm
    --, max(case when  isnull( Procedure1,'') in  ('99238','99239') then '1' else '0' end) as IPDisch
    , max(case when [ClassifierUSPM] = 'IP' then 1 else 0 END) as 'IP'
    , max(case when [ClassifierUSPM] = 'ER' then 1 else 0 END) as 'ER'
    , max(case when [ClassifierUSPM] = 'OP' then 1 else 0 END) as 'OP'
    , max(case when [ClassifierUSPM] = 'OV' then 1 else 0 END) as 'OV'
    , max(case when [ClassifierUSPM] = 'OTH' then 1 else 0 END) as 'OTH'

    , sum(PaidAmt) as Paid
    , sum(case when [ClassifierUSPM] = 'IP' then PaidAmt else 0 END) as 'IPPaid'
    , sum(case when [ClassifierUSPM] = 'ER' then PaidAmt else 0 end) as 'ERPaid'

    , sum(case when [ClassifierUSPM] = 'OP' then PaidAmt else 0 END) as 'OPPaid'
    , sum(case when [ClassifierUSPM] = 'OV' then PaidAmt else 0 end) as 'OVPaid'
    , sum(case when [ClassifierUSPM] = 'OTH' then PaidAmt else 0 end) as 'OTHPaid'

    , count(distinct ClaimNumber) as Claims
    , max(iif(e.m is null, 0,1)) as ExclFlg
    , max(ICD1) as PrimDiagnosis
    , max(ICD2) as SecDiagnosis1
    , max(ICD3) as SecDiagnosis2
    , max(DRG_Cde) as DRG
from [dbo].[MedicalClaims_Base] mc
    left join e
	   on mc.MemberID = e.m
	   and [YrMth] = k
group by [ClientId]
    , PriMemberID
    , [MemberID]
    , FromServiceDate
    , [YrMth]

) --select * from a where memberID = 'QhieaE4qTXUhlQ' order by 3
 , a2
as
(
select * 

    , rank() over (partition by memberID order by  ServiceDate) as rnk
    , lag(IP,1,null) over (partition by [MemberID] order by ServiceDate) as priorIP
from a


)

, ip
as
(
select distinct dateadd(day, (n.n-1), ServiceDate) ipDay
, ClientID as c
, PriMemberID as pm
, MemberID as m
, ServiceDate as sd
, DRG as dd
, 1 as ipf
, n
--select * 
from a
    inner join dbo.number n
	   on a.IP >= n
where IP > 0
   -- and n = 1
 --   AND dateadd(day, n.n, FromServiceDate) 


) --select * from ip order by 3, 4, 1



select distinct ClientID
    , PriMemberID
    , MemberID
    , ServiceDate
    , YrMth
    , TramaFlag
    , isnull(IPAdm , 0) as IPAdm
  --  , ipf
    , iif((coalesce(ipf ,0) + coalesce(IPAdm ,0))> 0,1,0) as IP
    , iif(isnull(ipf,0) > 0,0,ER) as ER
    , iif(isnull(ipf,0) > 0,0,OP) as OP
    , iif(isnull(ipf,0) > 0,0,OV) as OV
    , iif(isnull(ipf,0) > 0,0,OTH) as OTH
    , 1 as ClaimDay
    , Paid
    , iif(isnull(ipf,0) > 0,Paid,0) as IPPaid
    , iif(isnull(ipf,0) > 0,0,ERPaid) as ERPaid
    , iif(isnull(ipf,0) > 0,0,OPPaid) as OPPaid
    , iif(isnull(ipf,0) > 0,0,OVPaid) as OVPaid
    , iif(isnull(ipf,0) > 0,0,OTHPaid) as OTHPaid
    , TramaPaid
    , iif(isnull(ipf,0) > 0,TramaPaid,0) as TramaIPPaid
    , iif(isnull(ipf,0) > 0,0,TramaERPaid) as TramaERPaid
    , Claims
    , ExclFlg
    , PrimDiagnosis
    , SecDiagnosis1
    , SecDiagnosis2
    , ip.dd as DRG
from a2
    left join ip
	   on a2.memberID = ip.m
		  and a2.primemberid = ip.pm
		  and a2.ServiceDate = ip.ipDay
GO
PRINT N'Update complete.';


GO
